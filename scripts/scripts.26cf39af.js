"use strict";angular.module("shaibaApp",["ngAnimate","ngCookies","ngResource","ngRoute","ngSanitize","ngTouch","ui.bootstrap","ngFacebook","ngProgress"]).config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/main.html",controller:"MainCtrl"}).when("/about",{templateUrl:"views/about.html",controller:"AboutCtrl"}).when("/halloffame",{templateUrl:"views/halloffame.html",controller:"HallCtrl"}).when("/admin",{templateUrl:"views/admin.html",controller:"AdminCtrl",auth:!0}).otherwise({redirectTo:"/"})}]).config(["$facebookProvider",function(a){a.setAppId(0x55ba4d52c8d90)}]).run(["$location","$rootScope","$route",function(a,b){b.adminHitsCount=0,function(){if(!document.getElementById("facebook-jssdk")){var a=document.getElementsByTagName("script")[0],b=document.createElement("script");b.id="facebook-jssdk",b.src="//connect.facebook.net/en_US/all.js",a.parentNode.insertBefore(b,a)}}()}]).run(["$route","$location","$rootScope","$log","$modal",function(a,b,c,d,e){c.$on("$locationChangeStart",function(){var f=b.path(),g=a.routes[f];d.info(g),!c.isAdmin&&c.adminHitsCount>2&&e.open({templateUrl:"views/Partials/idareyouModal.html"}),g&&g.auth&&!c.isLoggedIn&&!c.isAdmin&&(b.path("#/"),c.adminHitsCount++,console.log(c.adminHitsCount))})}]),angular.module("shaibaApp").controller("MainCtrl",["$scope","parse","$q","$timeout","Facebook","AppAlert","Title","$rootScope","SharedData",function(a,b,c,d,e,f,g,h,i){g.setTitle("מחולל שייבה"),a.nation="",a.dish="",a.adj="",a.getSentence=function(){var d=b.getRandom("dishes"),e=b.getRandom("nations"),f=b.getRandom("adj");c.all([d,e,f]).then(function(b){h.favStarCss="glyphicon glyphicon-star favstar pull-left";var c=b[0],d=b[1],e=b[2],f="";"י"===d.name[d.name.length-1]&&(c.isPlural?f=c.isMale?"ם":"ות":c.isMale||(f="ת")),a.dish=c.name,a.nation=d.name+f,a.adj=e.name,console.log(b)},function(a){console.log("Failed to get one of them: "+a)})},a.addToHall=function(){h.isLoggedIn?""!==a.nation&&""!==a.dish&&""!==a.adj?b.getTable("best",!1).then(function(c){for(var d=a.dish+" "+a.nation+" "+a.adj,g=!1,j=0;j<c.length&&!g;j++)c[j].name===d&&(g=!0,h.favStarCss="glyphicon glyphicon-star favstar-disabled pull-left",f.add(i.appAlertTypes.WARNING,"המשפט כבר חוגג בהיכל התהילה, נשמה, נסה שוב"));g||(b.postToParse("best",{name:a.dish+" "+a.nation+" "+a.adj,grade:4,usersNumber:1,user:e.userDetails.userId,usersVoted:{__op:"AddUnique",objects:[e.userDetails.userId]}}).then(function(){h.favStarCss="glyphicon glyphicon-star favstar-disabled pull-left",b.getTable("best",!0)},function(){f.add(i.appAlertTypes.DANGER,"התרחשה בעיה בשרת")}),f.add(i.appAlertTypes.SUCCESS,"המשפט התווסף להיכל התהילה",4e3))},function(a){f.add(i.appAlertTypes.DANGER,"וואלה הפארס לא מגיב, נשמה "+a)}):f.add(i.appAlertTypes.WARNING,"שייבה לא אמר כלום יא פלופ! טיפ: לחץ על הראש.",4e3):f.add(i.appAlertTypes.WARNING,"אהבת את המשפט? רוצה להצביע? יאללה תתחבר לפייסבוק נשמה.",4e3)}}]),angular.module("shaibaApp").controller("AboutCtrl",["$scope","parse","AppAlert","Title","SharedData","$q","$modal",function(a,b,c,d,e,f,g){d.setTitle(e.siteTitles.SETTINGS),a.dishes="dishes",a.nations="nations",a.adj="adj";var h=function(a,c){var d=f.defer(),g=e.validationStates.VALID;return b.getTable(a,!1).then(function(a){""===c&&(g=e.validationStates.EMPTY),g===e.validationStates.VALID&&(c.length>20||c.length<2)&&(g=e.validationStates.WRONG_LENGTH);for(var b=0;b<a.length&&g===e.validationStates.VALID;b++)a[b].name===c&&(g=e.validationStates.ALREADY_EXISTS);d.resolve(g)},function(a){d.reject(a)}),d.promise},i=function(a){var d=g.open({templateUrl:"views/Partials/addDishModal.html",controller:"AddDishModalCtrl",resolve:{dishName:function(){return a}}});d.result.then(function(d){var f,g;switch(d){case e.suffixOptions.SINGLE_MALE:f=!0,g=!1;break;case e.suffixOptions.PLURAL_MALE:f=!0,g=!0;break;case e.suffixOptions.SINGLE_FEMALE:f=!1,g=!1;break;case e.suffixOptions.PLURAL_FEMALE:f=!1,g=!0}var h={name:a,isMale:f,isPlural:g};b.postToParse("dishes",h).then(function(d){b.getTable("dishes",!0),console.log(d),c.add(e.appAlertTypes.SUCCESS,a+e.validationStates.VALID,4e3)},function(b){console.log("ERROR: "+b),c.add(e.appAlertTypes.DANGER,a+"לא התווסף, שגיאה:"+b)})},function(){console.log("Modal dismissed at: "+new Date)})},j=function(a){var d={name:a};b.postToParse("adj",d).then(function(d){b.getTable("adj",!0),console.log(d),c.add(e.appAlertTypes.SUCCESS,a+e.validationStates.VALID,4e3)},function(b){console.log("ERROR: "+b),c.add(e.appAlertTypes.DANGER,a+"לא התווסף, שגיאה:"+b)})},k=function(a){var d={name:a};b.postToParse("nations",d).then(function(d){b.getTable("nations",!0),console.log(d),c.add(e.appAlertTypes.SUCCESS,a+e.validationStates.VALID,4e3)},function(b){console.log("ERROR: "+b),c.add(e.appAlertTypes.DANGER,a+"לא התווסף, שגיאה:"+b)})};a.postData=function(a,b){h(a,b).then(function(d){d===e.validationStates.VALID?"dishes"===a?i(b):"nations"===a?k(b):"adj"===a&&j(b):c.add(e.appAlertTypes.WARNING,d,4e3)},function(a){c.add(e.appAlertTypes.DANGER,"אנא נסה שוב, נוצרה שגיאה: "+a)})}}]).controller("AddDishModalCtrl",["$scope","$modalInstance","dishName","parse","SharedData",function(a,b,c,d,e){a.displayDish=c,a.displayNation="ישראלי",d.getRandom("nations").then(function(b){"י"===b.name[b.name.length-1]&&(a.displayNation=b.name)},function(a){console.log(a)}),a.suffixOptions=[e.suffixOptions.SINGLE_MALE,e.suffixOptions.PLURAL_MALE,e.suffixOptions.SINGLE_FEMALE,e.suffixOptions.PLURAL_FEMALE],a.correctSuffix=e.suffixOptions.SINGLE_MALE,a.ok=function(){b.close(a.correctSuffix)},a.cancel=function(){b.dismiss("cancel")}}]),angular.module("shaibaApp").directive("aboutDir",function(){return{template:"<div></div>",restrict:"E",link:function(a,b){b.text("this is the aboutDir directive")}}}),angular.module("shaibaApp").factory("parse",["$http","$q","ngProgress","SharedData",function(a,b,c,d){function e(a){return Math.floor(Math.random()*a)}function f(){var f=this;f.dishes=null,f.nations=null,f.adj=null,f.best=null,f.users=null,f.getTable=function(d,e){var g=b.defer();return e||null===f[d]?(c.start(),a.get("https://api.parse.com/1/classes/"+d).success(function(a){console.log(a.results),f[d]=a.results,g.resolve(a.results),c.complete()}).error(function(a){g.reject(a),c.complete()})):g.resolve(f[d]),g.promise},f.getRandom=function(a){var c=b.defer();return f.getTable(a,!1).then(function(a){c.resolve(a[e(a.length)])},function(a){c.reject(a)}),c.promise},f.postToParse=function(d,e){var f=b.defer();return c.start(),a.post("https://api.parse.com/1/classes/"+d,e).success(function(){c.complete(),f.resolve(JSON.stringify(e)+" posted to "+d)}).error(function(a,b){c.complete(),f.reject(a.name+" wasn't posted. Reason: "+b)}),f.promise},f.putToParse=function(c,e,f){var g=b.defer();return a.put("https://api.parse.com/1/classes/"+c+"/"+e,f).success(function(){g.resolve(d.parseResponse.SUCCESS)}).error(function(){g.reject(d.parseResponse.FAILED)}),g.promise},f.removeFromParse=function(c,e){var f=b.defer();return a.delete("https://api.parse.com/1/classes/"+c+"/"+e).success(function(){f.resolve(d.parseResponse.SUCCESS)}).error(function(){f.reject(d.parseResponse.FAILED)}),f.promise},f.getTableSize=function(d){var e=b.defer();return null!==f[d]?e.resolve(f[d].length):(c.start(),a.get("https://api.parse.com/1/classes/"+d).success(function(a){console.log(a.results),f[d]=a.results,e.resolve(a.results.length),c.complete()}).error(function(a){e.reject(a),c.complete()})),e.promise}}return a.defaults.headers.common["X-Parse-Application-Id"]="SyCWUj76oNwCrRpfvO2B5gdkm9uKvMkHNyEjZwCJ",a.defaults.headers.common["X-Parse-REST-API-Key"]="ykKXzomRdgxjdWPjPnhqcLFD7OmxAZbavzYOpIwr",new f}]),angular.module("shaibaApp").directive("onKeyupFn",function(){return function(a,b,c){var d=a.$eval(c.keyupParameters);b.bind("keyup",function(c){angular.forEach(d[1],function(e){e===c.which&&a.$apply(function(){d[0].call(a,d[2],b.val()),b.val("")})})})}}),angular.module("shaibaApp").controller("HallCtrl",["$scope","parse","Facebook","$rootScope","Title","AppAlert","SharedData","$timeout",function(a,b,c,d,e,f,g,h){function i(){b.getTable("best",!1).then(function(b){a.bestSentences=b,a.bestSentences.sort(j);for(var d=0;d<a.bestSentences.length;d++){a.bestSentences[d].prevGrade=a.bestSentences[d].grade,a.bestSentences[d].color="";var e=a.bestSentences[d];e.isReadOnly=!1;for(var f=0;f<e.usersVoted.length&&e.isReadOnly===!1;f++)(e.usersVoted[f]===c.getUserId()||""===c.getUserId())&&(e.isReadOnly=!0)}},function(a){console.log("Failed to get dish: "+a)})}function j(a,b){return a.grade>b.grade?-1:a.grade<b.grade?1:0}e.setTitle(g.siteTitles.HALL),a.bestSentences={},a.max=10,i(),a.changeRating=function(d){var e=a.bestSentences[d];if(!e.isReadOnly){e.color="rated-pending",e.grade=(e.usersNumber*e.prevGrade+e.grade)/(e.usersNumber+1),e.usersNumber++,e.isReadOnly=!0,e.usersVoted.push(c.getUserId()),a.bestSentences.sort(j);var i={grade:e.grade,usersNumber:e.usersNumber,usersVoted:{__op:"AddUnique",objects:[c.getUserId()]}};b.putToParse("best",e.objectId,i).then(function(){e.prevGrade=e.grade,e.color="rated-success",h(function(){e.color=""},3e3)},function(b){e.grade=e.prevGrade,e.usersNumber--,e.isReadOnly=!1;var d=e.usersVoted.indexOf(c.getUserId());d>-1&&e.usersVoted.splice(d,1),a.bestSentences.sort(j),f.add(g.appAlertTypes.DANGER,b,5e3),e.color="rated-failed",h(function(){e.color=""},5e3)})}},d.$watch(function(a){return a.isLoggedIn},function(){i()})}]),angular.module("shaibaApp").factory("AppAlert",["$rootScope","$timeout",function(a,b){a.alerts=[];var c={add:function(d,e,f){a.alerts.push({type:d,msg:e,close:function(){c.closeAlert(this)}}),f&&b(function(){c.closeAlert(this)},f)},closeAlert:function(b){return this.closeAlertIdx(a.alerts.indexOf(b))},closeAlertIdx:function(b){return a.alerts.splice(b,1)}};return c}]),angular.module("shaibaApp").factory("Facebook",["$facebook","$q","$rootScope","ngProgress","parse","SharedData","AppAlert",function(a,b,c,d,e,f,g){c.isLoggedIn=!1,c.isAdmin=!1,c.fbUserName=null,c.showFbLogin=!1;var h={userDetails:{userName:"",userEmail:"",userId:""},refresh:function(){var e=b.defer();return d.start(),a.api("/me").then(function(a){c.welcomeMsg="Welcome "+a.name,h.userDetails.userName=a.name,h.userDetails.userEmail=a.email,h.userDetails.userId=a.id,c.admins.indexOf(a.id)>=0&&(c.isAdmin=!0),c.showFbLogin=!1,c.isLoggedIn=!0,d.complete(),e.resolve(a)},function(){c.welcomeMsg="Please log in",c.showFbLogin=!0,d.complete(),e.reject(null)}),e.promise},getUserId:function(){return c.isLoggedIn===!0?h.userDetails.userId:""},login:function(){a.login().then(function(){console.log(h),h.refresh().then(function(a){e.getTable("users",!1).then(function(b){var c=!1;angular.forEach(b,function(b){console.log(b),b.fbId===a.id&&(c=!0)}),c||(e.postToParse("users",{fbId:a.id,fbUserName:a.name,fbEmail:a.email,isAdmin:!1}),console.log("New user!!"+a.id),g.add(f.appAlertTypes.INFO,"אני רואה שזאת פעם ראשונה שלך. ברוך הבא צעירו!"))})})})}};return h}]),angular.module("shaibaApp").directive("autocomplete",["$timeout",function(a){return function(b,c,d){c.autocomplete({source:b[d.uiItems],select:function(){a(function(){c.trigger("input")},0)}})}}]),angular.module("shaibaApp").controller("IndexCtrl",["$scope","Facebook","Title","AppAlert","parse","$rootScope",function(a,b,c,d,e,f){a.Title=c,f.admins=[],e.getTable("dishes"),e.getTable("nations"),e.getTable("adj"),e.getTable("best"),e.getTable("users").then(function(a){angular.forEach(a,function(a){a.isAdmin&&f.admins.push(a.fbId)}),b.refresh()},function(){b.refresh()}),a.menuItems={home:{href:"#/","class":"glyphicon glyphicon-home nav-custom"},about:{href:"#/about","class":"glyphicon glyphicon-pencil nav-custom"},hall:{href:"#/halloffame","class":"glyphicon glyphicon-star nav-custom"}},f.favStarCss="glyphicon glyphicon-star favstar pull-left",a.loginFacebook=function(){b.login()},a.Title=c,a.selectedIndex=0,a.itemClicked=function(b){a.selectedIndex=b}}]),angular.module("shaibaApp").factory("Title",["SharedData",function(a){var b=a.siteTitles.MAIN;return{getTitle:function(){return b},setTitle:function(a){b=a}}}]),angular.module("shaibaApp").directive("favStar",function(){return{template:'<span ng-click="addToHall()" class="{{ favStarCss }}" tooltip="הוסף להיכל התהילה" tooltip-trigger="mouseenter" tooltip-placement="right"/>',restrict:"E",link:function(){}}}),angular.module("shaibaApp").factory("SharedData",function(){return{validationStates:{VALID:" נוסף בהצלחה.",EMPTY:"שייבה בז למילים ריקות.",ALREADY_EXISTS:"תודה, אבל שייבה כבר מכיר את המילה.",NOT_HEBREW:"שייבה פלופ מספיק כבר בעברית. בואו לא נחצה גבולות שפה כרגע.",WHITE_SPACES:"תפסיק לדחוף רווחים לשייבה.",WRONG_LENGTH:"אחי, תנסה שוב משהו באורך הגיוני.",CONTAINS_NUMBERS:"מה מספרים אחי, מה? תעזור לשייבה להתפקס עם אותיות בעברית."},parseResponse:{SUCCESS:" נוסף בהצלחה.",FAILED:" לא התווסף. פארס כשל."},appAlertTypes:{SUCCESS:"success",WARNING:"warning",DANGER:"danger",INFO:"info"},siteTitles:{MAIN:"מחולל שייבה",SETTINGS:"הגדרות",HALL:"היכל התהילה"},suffixOptions:{SINGLE_MALE:"",PLURAL_MALE:"ם",SINGLE_FEMALE:"ת",PLURAL_FEMALE:"ות"}}}),angular.module("shaibaApp").controller("AdminCtrl",["$scope","parse","SharedData","Facebook","Title","AppAlert",function(a,b,c,d,e,f){function g(d){""!==a.selectedTable&&b.getTable(a.selectedTable,d).then(function(b){a.tableContent=b},function(a){f.add(c.appAlertTypes.DANGER,"Retrieving from parse failed. "+a)})}function h(c){b.getTableSize(a.tables[c].name).then(function(b){a.tables[c].size=b})}e.setTitle("מסך אדמינים"),a.selectedTable="adj",a.tableContent=[],a.selectedIndex=0,a.tables={dishes:{name:"dishes",size:0},nations:{name:"nations",size:0},adj:{name:"adj",size:0},users:{name:"users",size:0},best:{name:"best",size:0}},g(!1);for(var i in a.tables)h(i);a.removeDbItem=function(d,e){if("users"===a.selectedTable&&a.tableContent[e].isAdmin)return void f.add(c.appAlertTypes.DANGER,"אחי, תהיה קצת יותר אח. אתה לא יכול להעיף אדמין");var i=a.tableContent[e];i.color="rated-pending",b.removeFromParse(a.selectedTable,d).then(function(){a.tableContent.splice(e,1),g(!0),h(a.selectedTable)},function(a){i.color="rated-failed",f.add(c.appAlertTypes.DANGER,"Item could not be removed from Parse: "+a)})},a.selectTable=function(b){a.selectedTable=b,g(!1)},a.itemClicked=function(b){a.selectedIndex=b}}]);